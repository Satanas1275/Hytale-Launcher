# GitHub Actions workflow: build_release.yml
# Manual dispatch only - builds Python onefile (no console),
# bundles JS for Node (Electron-safe) and uploads a .zip artifact

on:
  workflow_dispatch:

name: Build release (onefile + JS bundle)

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # PYTHON SETUP
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python deps and PyInstaller
        shell: pwsh
        run: |
          if (Test-Path requirements.txt) {
            Write-Host "Installing requirements.txt..."
            pip install -r requirements.txt
          } else {
            Write-Host "No requirements.txt found."
          }

          Write-Host "Installing PyInstaller..."
          pip install pyinstaller

      # -----------------------------
      # NODE SETUP
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # -----------------------------
      # JAVASCRIPT BUILD (NODE SAFE)
      # -----------------------------
      - name: Build JavaScript (npm build or esbuild fallback)
        shell: pwsh
        run: |
          if (Test-Path package.json) {
            Write-Host "package.json found -> installing npm deps"
            npm ci

            $pkg = Get-Content package.json -Raw | ConvertFrom-Json
            if ($pkg.scripts -and $pkg.scripts.build) {
              Write-Host "Running npm run build..."
              npm run build
            } else {
              Write-Host "No build script. Bundling with esbuild (platform=node)..."
              npm i -D esbuild

              if (Test-Path main.js) {
                npx esbuild main.js `
                  --bundle `
                  --minify `
                  --platform=node `
                  --target=node18 `
                  --outfile=dist/main.js
              }
              elseif (Test-Path src\main.js) {
                npx esbuild src/main.js `
                  --bundle `
                  --minify `
                  --platform=node `
                  --target=node18 `
                  --outfile=dist/main.js
              }
              else {
                Write-Host "No JS entry found (main.js or src/main.js)."
              }
            }
          }
          else {
            Write-Host "No package.json. Using esbuild directly if possible..."
            if (Test-Path main.js) {
              npm init -y
              npm i -D esbuild

              npx esbuild main.js `
                --bundle `
                --minify `
                --platform=node `
                --target=node18 `
                --outfile=dist/main.js
            } else {
              Write-Host "No JavaScript found. Skipping JS build."
            }
          }

      # -----------------------------
      # PYTHON BUILD (ONEFILE)
      # -----------------------------
      - name: Build Python onefile (PyInstaller, no console)
        shell: pwsh
        run: |
          if (-not (Test-Path app.py)) {
            Write-Error "app.py not found at repository root."
            exit 1
          }

          $sep = if ($env:RUNNER_OS -eq 'Windows') { ';' } else { ':' }
          $addDataArgs = @()

          if (Test-Path templates) {
            $addDataArgs += "--add-data `"templates${sep}templates`""
            Write-Host "Including templates/"
          }

          if (Test-Path static) {
            $addDataArgs += "--add-data `"static${sep}static`""
            Write-Host "Including static/"
          }

          Write-Host "Running PyInstaller..."
          pyinstaller `
            --onefile `
            --noconsole `
            $addDataArgs `
            -n app `
            app.py

      # -----------------------------
      # PACKAGE RELEASE ZIP
      # -----------------------------
      - name: Prepare release ZIP
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force release_output -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path release_output | Out-Null

          # Python binary
          if (Test-Path dist\app.exe) {
            Copy-Item dist\app.exe release_output\ -Force
            Write-Host "Copied app.exe"
          }

          # JS output
          if (Test-Path dist\main.js) {
            Copy-Item dist\main.js release_output\ -Force
            Write-Host "Copied bundled JS"
          }

          # Optional runtime assets
          if (Test-Path templates) {
            Copy-Item templates release_output\templates -Recurse -Force
          }
          if (Test-Path static) {
            Copy-Item static release_output\static -Recurse -Force
          }

          Compress-Archive `
            -Path release_output\* `
            -DestinationPath app-release.zip `
            -Force

          Write-Host "Created app-release.zip"

      # -----------------------------
      # UPLOAD ARTIFACT
      # -----------------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app-release.zip
