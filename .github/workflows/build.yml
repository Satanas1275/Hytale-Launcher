name: Build HytaleLauncher (Electron + Python)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # SETUP NODE.JS
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # -----------------------------
      # INSTALL NPM DEPENDENCIES
      # -----------------------------
      - name: Install NPM deps
        run: |
          npm ci

      # -----------------------------
      # SETUP PYTHON
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python deps and PyInstaller
        run: |
          if (Test-Path requirements.txt) {
            pip install -r requirements.txt
          }
          pip install pyinstaller

      # -----------------------------
      # BUILD PYTHON BACKEND
      # -----------------------------
      - name: Build Python backend (onefile)
        shell: pwsh
        run: |
          $sep = if ($env:RUNNER_OS -eq 'Windows') { ';' } else { ':' }
          $args = @("--onefile", "--noconsole", "-n", "HytaleLauncherBackend")

          if (Test-Path templates) {
            $args += "--add-data"
            $args += "templates${sep}templates"
          }
          if (Test-Path static) {
            $args += "--add-data"
            $args += "static${sep}static"
          }

          $args += "app.py"
          pyinstaller @args

      # -----------------------------
      # COPY PYTHON BACKEND INTO ELECTRON RESOURCES
      # -----------------------------
      - name: Copy backend into Electron
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force electron-app/resources/backend -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path electron-app/resources/backend | Out-Null
          Copy-Item dist/HytaleLauncherBackend.exe electron-app/resources/backend/ -Force

      # -----------------------------
      # BUILD ELECTRON APP
      # -----------------------------
      - name: Build Electron app with electron-builder
        shell: pwsh
        run: |
          cd electron-app
          npm install
          npx electron-builder --windows --x64 --publish never
          cd ..

      # -----------------------------
      # COLLECT OUTPUTS
      # -----------------------------
      - name: Collect release files
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force release_output -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path release_output | Out-Null

          # Electron exe
          $exePath = Get-ChildItem electron-app/dist/win-unpacked/*.exe | Select-Object -First 1
          Copy-Item $exePath.FullName release_output/HytaleLauncher.exe -Force

          # Backend exe (optionnel si tu veux le garder séparé)
          if (Test-Path dist/HytaleLauncherBackend.exe) {
            Copy-Item dist/HytaleLauncherBackend.exe release_output/ -Force
          }

          Compress-Archive -Path release_output\* -DestinationPath HytaleLauncher-release.zip -Force

      # -----------------------------
      # UPLOAD ARTIFACT
      # -----------------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: HytaleLauncher-release
          path: HytaleLauncher-release.zip
