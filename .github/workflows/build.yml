# GitHub Actions workflow: build_release.yml
# Manual dispatch only - builds Python onefile (no console), compiles JS and uploads a .zip artifact
on:
  workflow_dispatch:

name: Build release (onefile + JS bundle)

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python deps and PyInstaller
        shell: pwsh
        run: |
          if (Test-Path requirements.txt) {
            Write-Host "Installing requirements.txt..."
            pip install -r requirements.txt
          } else {
            Write-Host "No requirements.txt found, skipping pip install -r requirements.txt"
          }
          Write-Host "Installing PyInstaller..."
          pip install pyinstaller

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build JavaScript (npm build or fallback to esbuild)
        shell: pwsh
        run: |
          if (Test-Path package.json) {
            Write-Host "package.json found -> using npm build if available"
            npm ci
            $pkg = Get-Content package.json -Raw | ConvertFrom-Json
            if ($pkg.scripts -and $pkg.scripts.build) {
              Write-Host "Running npm run build..."
              npm run build
            } else {
              Write-Host "No build script defined in package.json. Trying to bundle main.js via esbuild if present..."
              if (Test-Path main.js) {
                npm i -D esbuild
                npx esbuild main.js --bundle --minify --outfile=dist/main.js
              } elseif (Test-Path src\main.js) {
                npm i -D esbuild
                npx esbuild src\main.js --bundle --minify --outfile=dist/main.js
              } else {
                Write-Host "No JS entry found (main.js or src/main.js). Skipping JS bundling."
              }
            }
          } else {
            Write-Host "No package.json. Looking for main.js to bundle with esbuild..."
            if (Test-Path main.js) {
              npm init -y
              npm i -D esbuild
              npx esbuild main.js --bundle --minify --outfile=dist/main.js
            } else {
              Write-Host "No JS present. Skipping JS build."
            }
          }

      - name: Build Python onefile (PyInstaller, no console) and include templates/static if present
        shell: pwsh
        run: |
          if (-not (Test-Path app.py)) {
            Write-Error "app.py not found at repository root. Adjust filename in the workflow."
            exit 1
          }

          # Determine add-data separator depending on OS (Windows uses ';')
          $sep = if ($env:RUNNER_OS -eq 'Windows') { ';' } else { ':' }
          $addDataArgs = @()

          if (Test-Path templates) {
            $addDataArgs += "--add-data `"templates$septemplates`""
            Write-Host "Will include templates (PyInstaller add-data)."
          } else {
            Write-Host "No templates/ folder found."
          }

          if (Test-Path static) {
            $addDataArgs += "--add-data `"static$sepstatic`""
            Write-Host "Will include static (PyInstaller add-data)."
          } else {
            Write-Host "No static/ folder found."
          }

          # Build: produce a onefile executable with no console
          Write-Host "Running PyInstaller..."
          # -n app : name the binary 'app' (dist/app.exe). Change if you want another name.
          pyinstaller --onefile --noconsole $addDataArgs -n app app.py

      - name: Prepare release ZIP
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force release_output -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path release_output | Out-Null

          # Copy built python executable
          if (Test-Path dist\app.exe) {
            Copy-Item dist\app.exe -Destination release_output\ -Force
            Write-Host "Copied dist\\app.exe to release_output\\"
          } elseif (Test-Path dist\app) {
            Copy-Item dist\app -Destination release_output\ -Force
            Write-Host "Copied dist\\app to release_output\\"
          } else {
            Write-Host "No Python executable found in dist/. PyInstaller may have failed."
          }

          # Copy JS outputs (dist/ or build/)
          if (Test-Path dist) {
            Copy-Item -Path dist\* -Destination release_output\ -Recurse -Force
            Write-Host "Copied dist/* into release_output/"
          }
          if (Test-Path build) {
            Copy-Item -Path build\* -Destination release_output\ -Recurse -Force
            Write-Host "Copied build/* into release_output/"
          }

          # Also include templates/static folders as they may be needed at runtime
          if (Test-Path templates) {
            Copy-Item -Path templates\* -Destination release_output\templates -Recurse -Force
            Write-Host "Included templates/"
          }
          if (Test-Path static) {
            Copy-Item -Path static\* -Destination release_output\static -Recurse -Force
            Write-Host "Included static/"
          }

          # Create zip
          if (Test-Path release_output) {
            Compress-Archive -Path release_output\* -DestinationPath app-release.zip -Force
            Write-Host "Created app-release.zip"
          } else {
            Write-Error "Nothing to package into ZIP."
            exit 1
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app-release.zip
